/*!
 * dc-addons v0.8.1
 *
 * 2015-07-28 08:20:39
 *
 */
function connect(a){var b=mysql.createConnection({host:a.host,user:a.username,password:a.password,database:a.database});return b.connect(),b}function execute(a,b,c){a.query(b,function(a,b){if(a)throw a;console.log("Number of rows: "+b.length),c(crossfilter(b))})}function addTiming(a){var b=(new Date).getTime(),c=0;timing.length>0&&(c=b-timing[timing.length-1].time),timing.push({name:a,took:c,time:b})}function logTiming(){console.log("---------------"),console.log("Server Timing");for(var a=timing[timing.length-1].time-timing[0].time,b=0;b<timing.length;b++)console.log(timing[b].name+" took "+timing[b].took/1e3+" seconds ("+(timing[b].took/a*100).toFixed(3)+"%)");console.log("Total time: "+a/1e3+" seconds"),console.log("---------------"),timing=[]}var app=require("express")(),http=require("http").Server(app),io=require("socket.io")(http),jsdom=require("jsdom"),mysql=require("mysql"),crossfilter=require("crossfilter"),timing=[],configFile=process.argv[2],html='<html><head><script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-beta.12/dc.min.js"></script></head><body></body></html>';io.on("connection",function(a){var b=[],c=null;a.on("render",function(d){addTiming("start"),delete require.cache[require.resolve(configFile)];var e=require(configFile),f=e[d],g=[];b=[],f.charts.forEach(function(a,b){g.push({type:a.type,width:a.options.width,height:a.options.height})}),a.emit("preRender",g),addTiming("config loaded"),jsdom.env({features:{QuerySelector:!0},virtualConsole:jsdom.createVirtualConsole().sendTo(console),html:html,done:function(d,e){addTiming("jsdom loaded");var g=connect(f.connection);addTiming("connected to db"),execute(g,f.connection.sql,function(d){addTiming("sql query completed"),c=e;var g=e.document.getElementsByTagName("body")[0];e.dc.disableTransitions=!0,f.charts.forEach(function(a,c){try{var h=e.document.createElement("div");h.setAttribute("data-type",a.type),g.appendChild(h),a.options.dimension=d.dimension(a.options.dimension),a.options.group=a.options.group(a.options.dimension);var i=e.dc[a.type](h);i.options(a.options).render(),addTiming("chart number "+(c+1)+" of "+f.charts.length+" rendered"),b.push(i)}catch(a){console.trace(),console.warn(a)}}),logTiming(),a.emit("afterRender",g.innerHTML)})}})}),a.on("filter",function(d){addTiming("filtering started");try{var e=b[d[0]];if("object"==typeof d[1])if(null===d[1][0]||null===d[1][1])e.filter(null);else{var f=e.effectiveWidth(),g=e.x().domain(),h=[d[1][0]/f*(g[1]-g[0])+g[0],d[1][1]/f*(g[1]-g[0])+g[0]];h.isFiltered=function(a){return a>=this[0]&&a<this[1]},e.brush().extent(h),e.replaceFilter(h)}else e.filter(e.keyAccessor()(e.group().all()[d[1]]));c.dc.redrawAll(),a.emit("afterFilter",c.document.body.innerHTML),addTiming("filtering sent"),logTiming()}catch(b){console.log(b),a.emit("afterFilterError",b)}}),a.on("disconnect",function(){console.log("user disconnected")})}),http.listen(3e3,function(){console.log("Listening on http://127.0.0.1:3000/")});